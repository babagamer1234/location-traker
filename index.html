<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin â€“ Live Users</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: linear-gradient(135deg, #000428, #004e92);
    color: white;
    display: flex;
    height: 100vh;
  }
  #userList {
    width: 30%;
    background: rgba(255, 255, 255, 0.1);
    padding: 20px;
    overflow-y: auto;
    backdrop-filter: blur(10px);
  }
  .userItem {
    padding: 12px;
    margin-bottom: 10px;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    cursor: pointer;
    transition: 0.2s;
  }
  .userItem:hover {
    background: rgba(255, 255, 255, 0.35);
  }
  #map {
    flex: 1;
    height: 100%;
  }
</style>
</head>
<body>
<div id="userList">
  <h2>Live Users</h2>
  <div id="users"></div>
</div>
<div id="map"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Firebase config
const firebaseConfig = {
  apiKey: "AIzaSyA5iHHWvOKZnKlZCZz57O8ALtSkfNdMmrE",
  authDomain: "live-tracker-554a7.firebaseapp.com",
  databaseURL: "https://live-tracker-554a7-default-rtdb.firebaseio.com",
  projectId: "live-tracker-554a7",
  storageBucket: "live-tracker-554a7.firebasestorage.app",
  messagingSenderId: "951695061306",
  appId: "1:951695061306:web:a7b9478538f86f50a36003",
  measurementId: "G-V4LCZSEQLC"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Initialize map
const map = L.map('map').setView([20.5937, 78.9629], 5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors',
    maxZoom: 19
}).addTo(map);

const markers = {};

function loadUsers() {
  db.ref('users').on('value', snapshot => {
    const usersDiv = document.getElementById('users');
    usersDiv.innerHTML = '';

    const data = snapshot.val() || {};
    Object.keys(data).forEach(key => {
      const userNode = data[key];
      const loc = userNode.location || {};
      const meta = userNode.meta || {};
      const name = loc.name || meta.name || key;
      const online = meta.online === true || loc.online === true;
      const lat = loc.latitude;
      const lng = loc.longitude;

      const item = document.createElement('div');
      item.className = 'userItem';
      item.innerHTML = `<strong>${name}</strong><br><small>${online ? 'Active' : 'Offline'}</small>`;
      item.onclick = () => trackUser(key);

      usersDiv.appendChild(item);

      if(lat && lng){
        if(markers[key]){
          markers[key].setLatLng([lat,lng]);
        } else {
          markers[key] = L.marker([lat,lng]).addTo(map).bindPopup(`<b>${name}</b>`);
        }
      }
    });
  });
}

let trackedMarker = null;
function trackUser(key){
  db.ref('users/'+key+'/location').on('value', snap => {
    const loc = snap.val();
    if(!loc) return;
    const pos = [loc.latitude, loc.longitude];

    if(trackedMarker){
      trackedMarker.setLatLng(pos);
    } else {
      trackedMarker = L.marker(pos, {riseOnHover:true}).addTo(map).bindPopup(`<b>${loc.name}</b> (tracked)`);
    }
    map.setView(pos, 16);
  });
}

loadUsers();
</script>
</body>
</html>
